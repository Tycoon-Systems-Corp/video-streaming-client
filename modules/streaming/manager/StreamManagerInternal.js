function _extends(){return(_extends=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var a,r=arguments[t];for(a in r)Object.prototype.hasOwnProperty.call(r,a)&&(e[a]=r[a])}return e}).apply(this,arguments)}import React from"react";import{beginStream,endStream,updateStreamConfigRequest,requestStreamingPermissions}from"../../utility/streaming";import{checkSignedIn,logout}from"../../utility/onboarding/SignIn";import{v4 as uuidv4}from"uuid";import ManagerStyles from"./Manager.module.scss";import{StreamManagerInternal}from"./parts";const generateBackground=(e={})=>{var t=e?.palette??["#39e662","#71d1ff","#f371ff","#ee5252","#9a74ff","#4defc9"],a=Math.floor(Math.random()*t.length);let r=0;for(;a==(r=Math.floor(Math.random()*t.length)););e=Math.floor(360*Math.random());return console.log(t[a],t[r],e),`linear-gradient(${e}deg, ${t[a]} 0%, ${t[r]} 100%)`},Module=n=>{let[,t]=React.useState(null);const[a,A]=React.useState(!1),[e,N]=React.useState(null),[r,O]=React.useState(!1),[s,c]=React.useState(!1),[B,u]=React.useState(null),[K,i]=React.useState(null),[o,l]=React.useState(!1),[q,m]=React.useState(!1),[d,g]=React.useState({password:null,private:!1,dates:[],tags:[],input:[]}),[p,U]=React.useState(null),[S,v]=React.useState(null),[h,H]=React.useState([]),[f,R]=React.useState(!1),[$,y]=React.useState(!1),[J,z]=React.useState(!1),[,E]=React.useState(!1),_=React.useRef(),[k,b]=React.useState(!1),[G,Q]=React.useState(Array.from(Array(100).keys()).map(e=>generateBackground(n))),[V,T]=React.useState(0),C=React.useRef(),M=React.useRef(),w=React.useRef(),L=React.useRef(),I=React.useRef(),P=React.useRef(),F=React.useRef(),j=React.useRef(),D=(e&&(n._LocalEventEmitter.unsubscribe(e),n._LocalEventEmitter.subscribe(e,e=>{e&&e.dispatch&&"paintStreamData"===e.dispatch&&x(s)})),n._LocalEventEmitter.unsubscribe("manager"),n._LocalEventEmitter.subscribe("manager",e=>{e&&e.dispatch&&"setMenu"===e.dispatch&&"stream"===e?.menu&&setOpenMenu("stream")}),React.useEffect(()=>{var e;a||(e=uuidv4(),N(e),A(!0))},[a]),React.useEffect(()=>{n._loggedIn&&n._loggedIn.username&&!r&&(O(!0),D(!0))},[n._loggedIn,r,p]),async(e=!1)=>{try{var t,a,r;o||(l(!0),m(!0),_.current=setTimeout(()=>{l(!1),m(!1)},1e4),t={stripeSecret:n._stripeSecret,dontForce:e,streamSettings:d,streamingFor:p?.id??null},a=await beginStream(n.apiUrl,n.domainKey,t,checkSignedIn),_.current&&clearTimeout(_.current),console.log("Stream",a),a?"disauthenticated"==a?(n._setLoggedIn(!1),n._setStripeSecret(!1),l(!1),m(!1),logout()):"success"==a.status&&(l(!1),m(!1),console.log("check stream",a),z(a.canStream),a.askStream&&E(!0),a.upcomingEvents&&(H(a.upcomingEvents),Q(a.upcomingEvents.map(e=>generateBackground(n)))),a?.data?.streamForProduct?v(a.data.streamForProduct):v(null),a.data)&&"streaming"==a.data.status&&a.data.stream&&(c(a.data.stream),n?._setCurrentlyStreaming&&n._setCurrentlyStreaming(a.data.stream),x(a.data.stream),a.data.key&&u(a.data.key),a.data.streamTo&&i(a.data.streamTo),a.data.stream.meta&&a.data.stream.meta.streamSettings&&(r=a.data.stream.meta.streamSettings,g(r)),n._LocalEventEmitter)&&n._LocalEventEmitter.dispatch("refetchDefaults",{dispatch:"simple"}):(e?l:(n._setPageError("Failed to save begin stream"),l(!1),m))(!1))}catch(e){console.log(e),_.current&&clearTimeout(_.current),l(!1),m(!1)}}),x=e=>{try{e&&(I.current.value=e.title,P.current.value=e.description,F.current.value=e.tags)}catch(e){}};var W=React.useCallback(e=>{D()});React.useEffect(()=>{d&&(X(d),n._LocalEventEmitter.dispatch(e,{dispatch:"paintStreamData"}))},[e,n._LocalEventEmitter,n.adminPanelState,d]);const X=e=>{e=e||d;C.current&&(C.current.checked=e.private),M.current&&(M.current.checked=e.private),w.current&&(w.current.value=e.password),L.current&&(L.current.value=e.password)};var Y=React.useCallback(e=>{t(null)}),Z=React.useCallback(e=>{var t={...d},e=e.currentTarget.value.split(" ");const a=[],r=[];e.map(e=>{isNaN(new Date(e))?r.push(e):a.push(new Date(e))}),t.dates=a,t.tags=r,t.input=e,g(t)}),ee=React.useCallback(e=>{var t={...d};t.private=e.currentTarget.checked,g(t)}),te=React.useCallback(e=>{var t={...d};t.password=e.currentTarget.value,g(t)}),ae=React.useCallback(e=>{if(e.currentTarget.getAttribute("modif"))if("yes"==e.currentTarget.getAttribute("modif"))try{(async()=>{var e;console.log("end st",o),o||(l(!0),_.current=setTimeout(()=>{l(!1)},1e4),e={stream:s.id},e=await endStream(n.apiUrl,n.domainKey,e,checkSignedIn),_.current&&clearTimeout(_.current),e?"disauthenticated"==e?(R(!1),n._setLoggedIn(!1),n._setStripeSecret(!1),l(!1),logout()):"success"==e.status&&(R(!1),l(!1),c(!1),n?._setCurrentlyStreaming&&n._setCurrentlyStreaming(!1),u(null),i(null),g({password:null,private:!1,dates:[],tags:[],input:[]}),D(!0),n._LocalEventEmitter)&&n._LocalEventEmitter.dispatch("refetchDefaults",{dispatch:"simple"}):(R(!1),n._setPageError("Failed to end stream"),l(!1)))})()}catch(e){R(!1),_.current&&clearTimeout(_.current),l(!1)}else R(!1);else f||R(!0)});var re=React.useCallback(e=>{if(k)T("0px"),b(!1);else{b(!0);try{var t=j.current.children[0].clientHeight+(j.current.children[0].marginTop??0)+(j.current.children[0].marginBottom??0);T(t+"px")}catch(e){}}}),ne=React.useCallback(e=>{const t=e?.currentTarget?.getAttribute("modif")??null;var a;t&&(e=h.find(e=>e.id===t))&&((a=JSON.parse(JSON.stringify(d))).private=!0,g(a),C.current.checked=!0,U(e))}),se=React.useCallback(e=>{var t,a=e?.currentTarget?.getAttribute("modif")??"";a&&((t=d)[a]=e.currentTarget.value,console.log(t,a),g(t))});return React.useMemo(()=>{var e=d;console.log(I,e),I?.current&&e.title&&(I.current.value=e?.title),P?.current&&e?.description&&(P.current.value=e.description),F?.current&&(e?.input?.join&&0<e.input.length?F.current.value=e.input.join(" "):e?.tags?.join&&e.dates?.join&&(F.current.value=e.tags.join(" ")+" "+e.dates.join(" ")),e.streamForProduct)&&!F?.current?.value.match(e.streamForProduct)&&(F.current.value+=" "+e.streamForProduct),w?.current&&e.password&&(w.current.value=e.password),k&&j?.current?.children&&(e=j.current.children[0].clientHeight+(j.current.children[0].marginTop??0)+(j.current.children[0].marginBottom??0),T(e+"px"))},[d,I?.current,P?.current,F?.current,o]),console.log(S,d,s),React.createElement("div",{className:ManagerStyles.container+" "+n.className},React.createElement(StreamManagerInternal,_extends({},n,{backgrounds:G,beginSreaming:W,fetchBusy:o,currentlyStreaming:s,ongoingStreamFor:S,streamChecking:q,streamingFor:p,canStream:J,titleRef:I,descriptionRef:P,myTagsRef:F,updateStreamData:se,streamSettings:d,moreSettings:k,settingsHeight:V,moreSettingsContainerRef:j,openMoreSettings:re,updateTags:Z,setPrivate:ee,privateRef:C,upcomingStreams:h,setNextStream:ne,askEndStream:f,updatingStreamConfig:$,handleAskEndStream:ae,streamTo:K,streamKey:B,setPassword:te,passwordRef:w,checkStream:D,updateStreamConfigFn:async()=>{try{var e,t,a,r;o||(l(!0),y(!0),_.current=setTimeout(()=>{l(!1),y(!1)},1e4),e={title:I.current&&I.current.value?I.current.value:null,description:P.current&&P.current.value?P.current.value:null,tags:F.current&&F.current.value?F.current.value:null},t={stream:s.id,streamData:e,streamSettings:d},a=await updateStreamConfigRequest(n.apiUrl,n.domainKey,t,checkSignedIn),_.current&&clearTimeout(_.current),a?"disauthenticated"==a?(n._setLoggedIn(!1),n._setStripeSecret(!1),l(!1),y(!1),logout()):"success"==a.status&&(console.log("check stream",a),l(!1),y(!1),a.data)&&"streaming"==a.data.status&&(c(a.data.stream),n?._setCurrentlyStreaming&&n._setCurrentlyStreaming(a.data.stream),a.data.key&&u(a.data.key),a.data.streamTo&&i(a.data.streamTo),a.data.stream)&&a.data.stream.meta&&a.data.stream.meta.streamSettings&&(r=a.data.stream.meta.streamSettings,g(r)):(n._setPageError("Failed to save begin stream"),l(!1),y(!1)))}catch(e){console.log(e),_.current&&clearTimeout(_.current),l(!1),y(!1)}},handleClearError:Y,handleAskForStreamingPermissions:()=>{try{(async()=>{var e;o||(l(!0),_.current=setTimeout(()=>{l(!1)},1e4),e=await requestStreamingPermissions(n.apiUrl,n.domainKey,checkSignedIn),_.current&&clearTimeout(_.current),e?"disauthenticated"==e?(R(!1),n._setLoggedIn(!1),n._setStripeSecret(!1),l(!1),logout()):"success"==e.status&&(R(!1),l(!1),e?.data?.created&&E(!0),n._LocalEventEmitter)&&n._LocalEventEmitter.dispatch("refetchDefaults",{dispatch:"simple"}):(R(!1),l(!1)))})()}catch(e){_.current&&clearTimeout(_.current),l(!1)}}})))};export default Module;